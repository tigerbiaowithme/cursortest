# 环境变量详细说明

本文档详细解释为什么需要配置每个环境变量，以及它们的具体作用。

---

## 📋 为什么需要环境变量？

环境变量用于存储**敏感信息**和**配置信息**，而不是直接写在代码中。这样做的好处：

1. ✅ **安全性**：敏感信息（如密码、密钥）不会提交到 Git 代码仓库
2. ✅ **灵活性**：不同环境（开发、生产）可以使用不同的配置
3. ✅ **可维护性**：修改配置不需要修改代码，只需修改环境变量

---

## 🔑 环境变量详解

### 1. MONGODB_URI（MongoDB 连接字符串）

#### 📝 变量值：
```
MONGODB_URI=mongodb+srv://devos:3N-QDbcSfrFL36j@cluster0.d59flm2.mongodb.net/devos?appName=Cluster0
```

#### ❓ 为什么需要这个变量？

**原因 1：数据库连接必需**
- 应用程序需要连接 MongoDB Atlas 数据库
- 没有这个连接字符串，应用无法访问数据库
- 所有数据操作（用户登录、博客管理、询盘管理等）都会失败

**原因 2：包含敏感信息**
- 连接字符串包含：
  - 数据库用户名：`devos`
  - 数据库密码：`3N-QDbcSfrFL36j`
  - 集群地址：`cluster0.d59flm2.mongodb.net`
  - 数据库名：`devos`
- 这些信息不应该硬编码在代码中

**原因 3：不同环境不同配置**
- 开发环境：可能使用本地 MongoDB 或测试数据库
- 生产环境：使用 MongoDB Atlas 云数据库
- 通过环境变量可以轻松切换

#### 🔍 在代码中的使用：

**文件：`lib/db.ts`**
```typescript
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/devos';

async function connectDB() {
  // 使用 MONGODB_URI 连接数据库
  cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {
    return mongoose;
  });
}
```

**工作原理：**
1. 代码读取环境变量 `process.env.MONGODB_URI`
2. 如果没有设置，使用默认值（本地 MongoDB）
3. 使用连接字符串连接到 MongoDB Atlas

**如果没有配置会发生什么？**
- ❌ 应用启动时无法连接数据库
- ❌ 所有需要数据库的功能都会失败：
  - 用户无法登录
  - 无法保存博客文章
  - 无法保存询盘信息
  - 无法查看统计数据

---

### 2. JWT_SECRET（JWT 加密密钥）

#### 📝 变量值：
```
JWT_SECRET=dasdasdasfadsfdsafdasf
```
（建议使用更复杂的随机字符串）

#### ❓ 为什么需要这个变量？

**原因 1：用户认证安全**
- JWT（JSON Web Token）用于用户登录认证
- 后台管理员登录后，系统会生成一个 JWT token
- 这个 token 用于后续 API 请求的身份验证
- JWT_SECRET 用于**签名和验证**这个 token

**原因 2：防止 token 被伪造**
- 如果密钥泄露或被猜测，攻击者可以伪造 token
- 使用复杂、随机的密钥可以防止这种情况
- 不同环境应该使用不同的密钥

**原因 3：token 加密必需**
- JWT 库需要密钥来：
  - **签名**：生成 token 时使用密钥加密
  - **验证**：验证 token 时使用密钥解密
- 没有密钥，无法生成或验证 token

#### 🔍 在代码中的使用：

**文件：`app/api/auth/login/route.ts`**
```typescript
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';

// 用户登录成功后，生成 token
const token = jwt.sign(
  {
    userId: user._id,
    username: user.username,
    role: user.role,
  },
  JWT_SECRET,  // 使用 JWT_SECRET 签名
  { expiresIn: '7d' }
);
```

**文件：`lib/auth.ts`**
```typescript
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';

// 验证 token 是否有效
export function verifyToken(request: NextRequest): AuthUser | null {
  const token = request.headers.get('authorization')?.replace('Bearer ', '');
  const decoded = jwt.verify(token, JWT_SECRET);  // 使用 JWT_SECRET 验证
  return decoded;
}
```

**工作流程：**
1. 用户登录：输入用户名和密码
2. 验证成功：生成 JWT token（使用 `JWT_SECRET` 签名）
3. 前端保存：将 token 存储在浏览器中
4. API 请求：每次请求都携带 token
5. 后端验证：使用 `JWT_SECRET` 验证 token 是否有效

**如果没有配置会发生什么？**
- ⚠️ 代码有默认值，但这是不安全的
- ❌ 使用默认密钥容易被攻击
- ❌ 如果默认密钥泄露，所有 token 都可能被伪造
- ❌ 无法实现安全的用户认证

**安全建议：**
- ✅ 使用随机、复杂的字符串（至少 32 个字符）
- ✅ 不同环境使用不同的密钥
- ✅ 定期更换密钥（需要重新登录所有用户）

---

### 3. NODE_ENV（Node.js 环境变量）

#### 📝 变量值：
```
NODE_ENV=production
```
（开发环境：`development`，生产环境：`production`）

#### ❓ 为什么需要这个变量？

**原因 1：区分开发和生产环境**
- Node.js 和 Next.js 需要知道当前运行的环境
- 不同环境有不同的行为：
  - **开发环境**：启用调试、热重载、详细错误信息
  - **生产环境**：性能优化、压缩代码、简化错误信息

**原因 2：性能优化**
- Next.js 在生产环境会自动优化：
  - 代码压缩和混淆
  - 静态资源优化
  - 服务器端渲染优化
  - 禁用开发工具

**原因 3：安全考虑**
- 开发环境会显示详细的错误堆栈（包含代码路径）
- 生产环境只显示简化的错误信息
- 防止敏感信息泄露

**原因 4：依赖库行为**
- 许多 npm 包会根据 `NODE_ENV` 调整行为：
  - 日志库：开发环境输出详细信息，生产环境只输出错误
  - 数据库库：开发环境可能启用调试模式
  - 性能监控：生产环境启用监控

#### 🔍 在代码中的使用：

**Next.js 自动使用：**
```javascript
// Next.js 内部会自动检查 NODE_ENV
if (process.env.NODE_ENV === 'production') {
  // 生产环境行为
  - 代码压缩
  - 静态资源优化
  - 禁用开发工具
} else {
  // 开发环境行为
  - 启用热重载
  - 显示详细错误
  - 启用开发工具
}
```

**常见用法示例：**
```typescript
// 只在开发环境输出日志
if (process.env.NODE_ENV === 'development') {
  console.log('Debug info:', data);
}

// 生产环境使用错误监控服务
if (process.env.NODE_ENV === 'production') {
  // 发送错误到监控服务
  errorTracking.captureException(error);
}
```

**如果没有配置会发生什么？**
- ⚠️ 默认通常是 `development` 模式
- ❌ 生产环境运行开发模式会导致：
  - 性能下降（没有优化）
  - 安全性降低（显示详细错误）
  - 内存占用增加（开发工具）
  - 代码体积增大（没有压缩）

---

## 📊 环境变量对比表

| 环境变量 | 开发环境值 | 生产环境值 | 是否必需 | 安全性 |
|---------|-----------|-----------|---------|--------|
| `MONGODB_URI` | 本地或测试数据库 | MongoDB Atlas 连接字符串 | ✅ **必需** | ⚠️ 包含密码 |
| `JWT_SECRET` | 开发密钥 | 生产密钥（复杂随机字符串） | ✅ **必需** | ⚠️ 高敏感 |
| `NODE_ENV` | `development` | `production` | ✅ **必需** | ✅ 不敏感 |

---

## 🔐 安全最佳实践

### 1. MONGODB_URI
- ✅ 不要在代码中硬编码
- ✅ 不要在 Git 仓库中提交（已在 `.gitignore` 中）
- ✅ 使用环境变量存储
- ✅ 定期更换密码
- ✅ 限制数据库访问权限（IP 白名单）

### 2. JWT_SECRET
- ✅ 使用随机、复杂的字符串（至少 32 个字符）
- ✅ 不同环境使用不同的密钥
- ✅ 不要使用默认值
- ✅ 定期更换密钥
- ✅ 不要在代码中硬编码

### 3. NODE_ENV
- ✅ 开发环境使用 `development`
- ✅ 生产环境使用 `production`
- ✅ 确保正确设置（影响性能和安全性）

---

## 📝 总结

### 为什么这三个变量都必需？

1. **MONGODB_URI**
   - 没有它 → 无法连接数据库 → 应用无法工作
   - 所有数据相关功能都会失败

2. **JWT_SECRET**
   - 没有它 → 无法安全认证用户 → 后台登录功能不安全
   - 可能被攻击者伪造 token

3. **NODE_ENV**
   - 没有它 → 生产环境性能差、不安全
   - 应该设置为 `production` 以获得最佳性能和安全

### 配置环境变量的好处

- ✅ **安全性**：敏感信息不泄露
- ✅ **灵活性**：不同环境不同配置
- ✅ **可维护性**：修改配置不需要改代码
- ✅ **性能**：生产环境自动优化
- ✅ **可靠性**：应用正常工作

---

## 🚀 下一步

配置好环境变量后，您的应用就可以：
- ✅ 连接到 MongoDB Atlas 数据库
- ✅ 安全地进行用户认证
- ✅ 在生产环境中高性能运行

参考文档：
- [Coolify部署完整指南.md](./Coolify部署完整指南.md)
- [环境变量配置说明.md](./环境变量配置说明.md)
